{% extends 'wedding/base.html' %}
{% load crispy_forms_tags %}

{% block title %}RSVP - Dennis & Cait{% endblock %}

{% block content %}
<div class="page-header">
  <div class="container">
    <h1 class="display-4">RSVP</h1>
    <p class="lead">We can't wait to celebrate with you!</p>
  </div>
</div>

<div class="container my-5">
  <div class="row justify-content-center">
    <div class="col-lg-8">
      <div class="rsvp-form-container">
        <div class="text-center mb-4">
          <div class="penguin-pair-rsvp">
            <span>üêßüíïüêß</span>
          </div>
          <p class="mt-3">Please RSVP by <strong>July 1st, 2026</strong></p>
        </div>

        <form method="post" class="rsvp-form">
          {% csrf_token %}

          <div class="form-section">
            <h5 class="mb-3">Your Information</h5>
            <div class="row">
              <div class="col-md-6">
                {{ form.first_name|as_crispy_field }}
              </div>
              <div class="col-md-6">
                {{ form.last_name|as_crispy_field }}
              </div>
            </div>
            <div class="row">
              <div class="col-md-6">
                {{ form.email|as_crispy_field }}
              </div>
              <div class="col-md-6">
                {{ form.phone|as_crispy_field }}
              </div>
            </div>
          </div>

          <div class="form-section">
            <h5 class="mb-3">Attendance</h5>
            {{ form.attendance|as_crispy_field }}
          </div>

          <div class="form-section">
            <h5 class="mb-3">Guest Details</h5>
            {{ form.number_of_guests|as_crispy_field }}

            <!-- Dynamic guest fields container -->
            <div id="guestFieldsContainer"></div>

            {{ form.dietary_restrictions|as_crispy_field }}
          </div>

          <div class="form-section">
            <h5 class="mb-3">Special Requests</h5>
            {{ form.song_request|as_crispy_field }}
            {{ form.message|as_crispy_field }}
          </div>

          <div class="text-center mt-4">
            <button type="submit" class="btn btn-primary wedding-btn-primary btn-lg">
              <i class="fas fa-paper-plane"></i> Submit RSVP
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  // Dynamically add guest name fields based on number of guests
  document.addEventListener('DOMContentLoaded', function() {
    const numberOfGuestsInput = document.getElementById('id_number_of_guests');
    const guestFieldsContainer = document.getElementById('guestFieldsContainer');

    function updateGuestFields() {
      const numberOfGuests = parseInt(numberOfGuestsInput.value) || 1;
      const additionalGuests = Math.max(0, numberOfGuests - 1); // -1 because primary is the submitter

      // Clear existing fields
      guestFieldsContainer.innerHTML = '';

      if (additionalGuests === 0) {
        return;
      }

      // Add header
      const header = document.createElement('div');
      header.className = 'mt-3 mb-2';
      header.innerHTML = '<p class="text-muted"><small>Please provide names for your additional guests:</small></p>';
      guestFieldsContainer.appendChild(header);

      // Create fields for each additional guest
      for (let i = 0; i < additionalGuests; i++) {
        const guestDiv = document.createElement('div');
        guestDiv.className = 'guest-fields-group p-3 mb-3 border rounded';
        guestDiv.innerHTML = `
          <h6 class="mb-3">Guest ${i + 1}</h6>
          <div class="row">
            <div class="col-md-6">
              <div class="form-group">
                <label for="guest_${i}_first_name">First Name</label>
                <input type="text" class="form-control" id="guest_${i}_first_name" name="guest_${i}_first_name" required>
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-group">
                <label for="guest_${i}_last_name">Last Name</label>
                <input type="text" class="form-control" id="guest_${i}_last_name" name="guest_${i}_last_name" required>
              </div>
            </div>
          </div>
          <div class="form-check mb-2">
            <input type="checkbox" class="form-check-input" id="guest_${i}_use_primary_phone" name="guest_${i}_use_primary_phone" checked onchange="toggleGuestPhone(${i})">
            <label class="form-check-label" for="guest_${i}_use_primary_phone">
              Same number ok to reach them with information day of (like seats)?
            </label>
          </div>
          <div class="form-group" id="guest_${i}_phone_group" style="display: none;">
            <label for="guest_${i}_phone">Their Phone Number</label>
            <input type="text" class="form-control" id="guest_${i}_phone" name="guest_${i}_phone" placeholder="(123) 456-7890">
          </div>
        `;
        guestFieldsContainer.appendChild(guestDiv);
      }
    }

    // Toggle guest phone field visibility
    window.toggleGuestPhone = function(guestIndex) {
      const checkbox = document.getElementById(`guest_${guestIndex}_use_primary_phone`);
      const phoneGroup = document.getElementById(`guest_${guestIndex}_phone_group`);
      const phoneInput = document.getElementById(`guest_${guestIndex}_phone`);

      if (checkbox.checked) {
        phoneGroup.style.display = 'none';
        phoneInput.removeAttribute('required');
      } else {
        phoneGroup.style.display = 'block';
        phoneInput.setAttribute('required', 'required');
      }
    };

    // Update fields on page load and when number changes
    updateGuestFields();
    numberOfGuestsInput.addEventListener('change', updateGuestFields);
    numberOfGuestsInput.addEventListener('input', updateGuestFields);
  });
</script>
{% endblock %}
